// tasks.js
let allTasks = [];
let allProjects = [];
let editingTaskId = null;

$(document).ready(function() {
    loadProjects();
    loadTasks();
    
    $('#statusFilter, #priorityFilter, #projectFilter').on('change', filterTasks);
});

async function loadProjects() {
    try {
        allProjects = await projectAPI.getByOrganisation(window.APP.ORG_ID);
        
        // Populate project filters and selects
        const projectOptions = allProjects.map(p => 
            `<option value="${p.id}">${p.name}</option>`
        ).join('');
        
        $('#projectFilter').append(projectOptions);
        $('#taskProjectSelect').append(projectOptions);
    } catch (error) {
        console.error('Failed to load projects:', error);
    }
}

async function loadTasks() {
    try {
        loadingUtils.show('#tasksTable tbody');
        
        // Load tasks for all projects
        const taskPromises = allProjects.map(p => taskAPI.getByProject(p.id));
        const taskArrays = await Promise.all(taskPromises);
        allTasks = taskArrays.flat();
        
        renderTasks(allTasks);
    } catch (error) {
        console.error('Failed to load tasks:', error);
        showToast('Failed to load tasks', 'error');
    } finally {
        loadingUtils.hide();
    }
}

function renderTasks(tasks) {
    const tbody = $('#tasksTable tbody');
    
    if (tasks.length === 0) {
        tbody.html(`
            <tr>
                <td colspan="7" class="text-center text-muted py-5">
                    <i class="fas fa-tasks fa-3x mb-3 opacity-50"></i>
                    <p>No tasks found</p>
                </td>
            </tr>
        `);
        return;
    }

    const html = tasks.map(task => {
        const project = allProjects.find(p => p.id === task.projectId);
        return `
            <tr>
                <td>
                    <a href="${window.APP.CONTEXT_PATH}/work/tasks/${task.id}" 
                       class="text-decoration-none fw-semibold">
                        ${task.title}
                    </a>
                </td>
                <td>${project ? project.name : 'N/A'}</td>
                <td>${task.assignedToName || 'Unassigned'}</td>
                <td>${getPriorityBadge(task.priority)}</td>
                <td>${getStatusBadge(task.status)}</td>
                <td>${formatDate(task.dueDate)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="${window.APP.CONTEXT_PATH}/work/tasks/${task.id}" 
                           class="btn btn-outline-primary" title="View Details">
                            <i class="fas fa-eye"></i>
                        </a>
                        <button class="btn btn-outline-warning" 
                                onclick="editTask(${task.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" 
                                onclick="deleteTask(${task.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    tbody.html(html);
}

function openTaskModal() {
    editingTaskId = null;
    $('#taskModalTitle').text('Add New Task');
    modalUtils.resetForm('taskModal');
    
    $('[name="status"]').val('PENDING');
    $('[name="priority"]').val('MEDIUM');
    
    modalUtils.open('taskModal');
}



async function editTask(id) {
    try {
        loadingUtils.show();
        const task = await taskAPI.getById(id);
        
        editingTaskId = id;
        $('#taskModalTitle').text('Edit Task');
        
        // Populate form
        Object.keys(task).forEach(key => {
            const input = $(`[name="${key}"]`);
            if (input.length) {
                if (input.attr('type') === 'date' && task[key]) {
                    input.val(task[key].split('T')[0]);
                } else {
                    input.val(task[key]);
                }
            }
        });
        
        modalUtils.open('taskModal');
    } catch (error) {
        showToast('Failed to load task details', 'error');
    } finally {
        loadingUtils.hide();
    }
}

async function saveTask() {
    const form = document.getElementById('taskForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);
    const data = {
        createdBy: window.APP.EMPLOYEE_ID
    };
    
    formData.forEach((value, key) => {
        if (value) {
            data[key] = key.includes('Hours') ? parseFloat(value) : value;
        }
    });

    try {
        loadingUtils.show();
        
        if (editingTaskId) {
            await taskAPI.update(editingTaskId, data);
            showToast('Task updated successfully', 'success');
        } else {
            await taskAPI.create(data);
            showToast('Task created successfully', 'success');
        }
        
        modalUtils.close('taskModal');
        loadTasks();
    } catch (error) {
        showToast(error.message || 'Failed to save task', 'error');
    } finally {
        loadingUtils.hide();
    }
}

function deleteTask(id) {
    modalUtils.confirm(
        'Delete Task',
        'Are you sure you want to delete this task?',
        async () => {
            try {
                loadingUtils.show();
                await taskAPI.delete(id);
                showToast('Task deleted successfully', 'success');
                loadTasks();
            } catch (error) {
                showToast('Failed to delete task', 'error');
            } finally {
                loadingUtils.hide();
            }
        }
    );
}

function filterTasks() {
    const status = $('#statusFilter').val();
    const priority = $('#priorityFilter').val();
    const projectId = $('#projectFilter').val();
    
    let filtered = [...allTasks];
    
    if (status) {
        filtered = filtered.filter(t => t.status === status);
    }
    
    if (priority) {
        filtered = filtered.filter(t => t.priority === priority);
    }
    
    if (projectId) {
        filtered = filtered.filter(t => t.projectId == projectId);
    }
    
    renderTasks(filtered);
}

function resetTaskFilters() {
    $('#statusFilter').val('');
    $('#priorityFilter').val('');
    $('#projectFilter').val('');
    renderTasks(allTasks);
}